# Zephix Platform - Railway Monorepo Configuration
# Enterprise-grade Infrastructure as Code for NestJS Backend + React Frontend
# 
# Architecture:
# - Backend: NestJS TypeScript application (zephix-backend/)
# - Frontend: React TypeScript application (zephix-frontend/)
# - Database: PostgreSQL (managed by Railway)
#
# @author Zephix Development Team
# @version 2.1.0

[build]
builder = "DOCKERFILE"

# =============================================================================
# BACKEND SERVICE CONFIGURATION
# =============================================================================
[services.backend]
# Service identification and metadata
name = "Zephix Backend"
description = "NestJS API backend for Zephix Platform"

# Monorepo source configuration - CRITICAL FIX
# Railway expects the source to be the relative path from repository root
source = "zephix-backend"

# Build configuration for NestJS TypeScript
[services.backend.build]
builder = "DOCKERFILE"

# Deployment configuration
[services.backend.deploy]
startCommand = "npm run start:prod"
healthcheckPath = "/api/health"
healthcheckTimeout = 300
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

# Environment variables for production
[services.backend.variables]
NODE_ENV = "production"
PORT = "3000"
JWT_SECRET = "ZephixJWT2024SecureKey!"
JWT_EXPIRES_IN = "15m"
DATABASE_URL = "{{.Postgres.DATABASE_URL}}"
LOG_LEVEL = "info"
CORS_ORIGIN = "https://getzephix.com"
API_PREFIX = "/api"

# Resource allocation
[services.backend.resources]
cpu = "0.5"
memory = "512MB"

# =============================================================================
# FRONTEND SERVICE CONFIGURATION
# =============================================================================
[services.frontend]
# Service identification and metadata
name = "Zephix Frontend"
description = "React TypeScript frontend for Zephix Platform"

# Monorepo source configuration
source = "zephix-frontend"

# Build configuration for React TypeScript with Docker
[services.frontend.build]
builder = "DOCKERFILE"
dockerfilePath = "zephix-frontend/Dockerfile"

# Deployment configuration
[services.frontend.deploy]
healthcheckPath = "/"
healthcheckTimeout = 300
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

# Environment variables for production
[services.frontend.variables]
NODE_ENV = "production"
PORT = "80"
VITE_API_BASE_URL = "https://getzephix.com/api"
VITE_APP_NAME = "Zephix AI"
VITE_APP_VERSION = "2.0.0"

# Resource allocation
[services.frontend.resources]
cpu = "0.25"
memory = "256MB"

# =============================================================================
# DATABASE SERVICE CONFIGURATION (ENHANCED for crash prevention)
# =============================================================================
[services.database]
# Service identification and metadata
name = "Zephix Database"
description = "PostgreSQL database for Zephix Platform - Enhanced for stability"

# Database configuration
source = "postgresql"

# ENHANCED: Database environment variables for crash prevention
[services.database.variables]
POSTGRES_PASSWORD = "{{.RandomString}}"
POSTGRES_DB = "zephix_production"
# CRITICAL: PostgreSQL configuration for Railway stability
POSTGRES_INITDB_ARGS = "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
# Memory and connection settings
POSTGRES_SHARED_PRELOAD_LIBRARIES = "pg_stat_statements"
POSTGRES_MAX_CONNECTIONS = "50"
POSTGRES_SHARED_BUFFERS = "128MB"
POSTGRES_EFFECTIVE_CACHE_SIZE = "256MB"
POSTGRES_WORK_MEM = "4MB"
POSTGRES_MAINTENANCE_WORK_MEM = "32MB"
POSTGRES_CHECKPOINT_SEGMENTS = "8"
POSTGRES_CHECKPOINT_COMPLETION_TARGET = "0.9"
POSTGRES_WAL_BUFFERS = "4MB"
POSTGRES_DEFAULT_STATISTICS_TARGET = "100"
POSTGRES_RANDOM_PAGE_COST = "1.1"
POSTGRES_EFFECTIVE_IO_CONCURRENCY = "200"
POSTGRES_WORK_MEM = "4MB"
POSTGRES_MAINTENANCE_WORK_MEM = "32MB"
POSTGRES_AUTOVACUUM_MAX_WORKERS = "3"
POSTGRES_AUTOVACUUM_NAPTIME = "60"
POSTGRES_LOG_STATEMENT = "all"
POSTGRES_LOG_MIN_DURATION_STATEMENT = "1000"

# ENHANCED: Increased resource allocation for database stability
[services.database.resources]
cpu = "0.5"  # Increased from 0.25
memory = "512MB"  # Increased from 256MB

# =============================================================================
# NETWORKING CONFIGURATION
# =============================================================================
[network]
# Domain configuration
domains = [
  "getzephix.com",
  "api.getzephix.com"
]

# SSL/TLS configuration
[network.ssl]
enabled = true
redirect = true

# =============================================================================
# MONITORING AND LOGGING
# =============================================================================
[monitoring]
# Logging configuration
[monitoring.logging]
level = "info"
retention = "30d"

# Metrics configuration
[monitoring.metrics]
enabled = true
interval = "60s"

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================
[security]
# CORS configuration
[security.cors]
enabled = true
origins = ["https://getzephix.com", "https://www.getzephix.com"]

# Rate limiting
[security.rateLimit]
enabled = true
requests = 100
window = "1m"

# =============================================================================
# DEPLOYMENT STRATEGY
# =============================================================================
[deployment]
# Deployment strategy
strategy = "rolling"

# Health check configuration
[deployment.healthCheck]
enabled = true
path = "/api/health"
timeout = 300
interval = 30
retries = 3

# Rollback configuration
[deployment.rollback]
enabled = true
automatic = true
threshold = 3
