name: Schema Parity Check

on:
  schedule:
    - cron: '0 3 * * *' # Nightly at 3 AM UTC
  workflow_dispatch: # Manual trigger

env:
  NODE_VERSION: '20'

jobs:
  schema-parity:
    name: Verify Schema Parity Across Environments
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: zephix_parity
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: zephix-backend/package-lock.json

      - name: Install dependencies
        working-directory: zephix-backend
        run: npm ci

      - name: Build backend
        working-directory: zephix-backend
        run: npm run build

      # Gate 1: Migrations run clean on fresh DB
      - name: Run migrations (first pass)
        working-directory: zephix-backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/zephix_parity
        run: node dist/src/scripts/db/migrate.js

      # Gate 2: Migrations are idempotent (second pass = no-op)
      - name: Run migrations (second pass — must be idempotent)
        working-directory: zephix-backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/zephix_parity
        run: node dist/src/scripts/db/migrate.js

      # Gate 3: Schema hash matches expectations
      - name: Compute schema hash and verify tables
        working-directory: zephix-backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/zephix_parity
        run: |
          node -e "
          const { Client } = require('pg');
          const crypto = require('crypto');
          async function main() {
            const c = new Client({ connectionString: process.env.DATABASE_URL });
            await c.connect();
            
            // Get all tables
            const tables = await c.query(
              \"SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE' ORDER BY table_name\"
            );
            
            // Get columns per table
            const lines = [];
            for (const t of tables.rows) {
              const cols = await c.query(
                'SELECT column_name FROM information_schema.columns WHERE table_name = \$1 AND table_schema = \'public\' ORDER BY column_name',
                [t.table_name]
              );
              lines.push(t.table_name + ':' + cols.rows.map(c => c.column_name).join(','));
            }
            
            const hash = crypto.createHash('sha1').update(lines.join('\n')).digest('hex').substring(0, 16);
            console.log('Schema hash:', hash);
            console.log('Tables:', tables.rows.length);
            
            // Verify critical tables exist
            const critical = ['audit_events','attachments','workspace_storage_usage','schedule_baselines','earned_value_snapshots','workspace_member_capacity','scenario_plans','work_tasks','projects','workspaces','organizations'];
            const tableNames = tables.rows.map(r => r.table_name);
            const missing = critical.filter(t => !tableNames.includes(t));
            if (missing.length > 0) {
              console.error('MISSING CRITICAL TABLES:', missing.join(', '));
              process.exit(1);
            }
            console.log('All critical tables present');
            
            await c.end();
          }
          main().catch(e => { console.error(e); process.exit(1); });
          "

      # Gate 4: Run strict schema seed at scale 0.05 (fast)
      - name: Run scale seed (strict schema, scale 0.05)
        working-directory: zephix-backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/zephix_parity
        run: |
          npx ts-node -r tsconfig-paths/register src/scripts/scale-seed/index.ts seed \
            --seed=999 --scale=0.05 --orgSlug=parity-check --strictSchema=true \
            || (echo "::error::Strict schema seed failed — schema parity broken" && exit 1)

      # Gate 5: Cleanup removes everything
      - name: Run scale seed cleanup
        working-directory: zephix-backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/zephix_parity
        run: |
          npx ts-node -r tsconfig-paths/register src/scripts/scale-seed/index.ts cleanup \
            --seed=999 --orgSlug=parity-check

      - name: Summary
        run: |
          echo "## Schema Parity Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Migrations: idempotent (2 passes clean)" >> $GITHUB_STEP_SUMMARY
          echo "- Critical tables: all present" >> $GITHUB_STEP_SUMMARY
          echo "- Strict schema seed: passed" >> $GITHUB_STEP_SUMMARY
          echo "- Cleanup: zero residue" >> $GITHUB_STEP_SUMMARY
