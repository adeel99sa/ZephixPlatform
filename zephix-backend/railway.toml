# ROOT DIRECTORY: Backend service Root Directory MUST be zephix-backend (Variant A).
# If Root Directory is repo root: use Variant B below and Pre-deploy = "cd zephix-backend && npm run db:migrate".
#
# Variant A (Root Directory = zephix-backend):
#   Pre-deploy: npm run db:migrate
# Variant B (repo root): replace build/start/postBuild with:
#   buildCommand = "cd zephix-backend && npm ci --legacy-peer-deps && npm run build"
#   startCommand = "cd zephix-backend && npm run start:railway"
#   postBuildCommand = "cd zephix-backend && test -f dist/src/main.js || (echo 'dist/src/main.js missing' && exit 1)"
#   Pre-deploy: cd zephix-backend && npm run db:migrate
#
# Healthcheck Path must be /api/health/ready (global prefix is api).
[build]
builder = "nixpacks"
buildCommand = "npm ci --legacy-peer-deps && npm run build"
postBuildCommand = "test -f dist/src/main.js || (echo 'dist/src/main.js missing' && exit 1)"

[deploy]
startCommand = "npm run start:railway"
healthcheckPath = "/api/health/ready"
healthcheckTimeout = 10
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3

# Port and env (Railway may override)
[deploy.envs]
NODE_ENV = "production"
PORT = "3000"
