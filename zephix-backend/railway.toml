[build]
builder = "nixpacks"
# CRITICAL: Build must fail fast on errors - no stale images
# Railway will not deploy if buildCommand exits with non-zero
buildCommand = "npm ci && npm run build"
# Verify build succeeded before proceeding
postBuildCommand = "test -f dist/main.js || (echo '‚ùå Build failed: dist/main.js not found' && exit 1)"

[deploy]
startCommand = "npm run start:railway"
# CRITICAL FIX: Health check path must match actual endpoint
healthcheckPath = "/api/health"
healthcheckTimeout = 30
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3

# CRITICAL: Port configuration for Railway routing
[deploy.envs]
NODE_ENV = "production"
PORT = "3000"
APP_VERSION = "1.0.0"

# Security settings for Railway
[deploy.envs.security]
HELMET_ENABLED = "true"
# CORS_ALLOWED_ORIGINS set in Railway UI per environment
RATE_LIMIT_ENABLED = "true"
RATE_LIMIT_WINDOW_MS = "60000"
RATE_LIMIT_MAX = "100"
AUTH_RATE_LIMIT_WINDOW_MS = "900000"
AUTH_RATE_LIMIT_MAX = "5"

# Observability for Railway
[deploy.envs.observability]
LOG_LEVEL = "info"
METRICS_ENABLED = "true"
OTEL_ENABLED = "true"
OTEL_SERVICE_NAME = "zephix-backend"
OTEL_SERVICE_VERSION = "1.0.0"

# Migration configuration
[deploy.envs.migrations]
AUTO_RUN_ON_BOOT = "false"
TRANSACTION_MODE = "each"
RETRY_ATTEMPTS = "15"
RETRY_DELAY = "5000"
TIMEOUT_MS = "300000"

# CRITICAL: Health check configuration for Railway routing
[deploy.envs.health]
ENDPOINT = "/api/health"
TIMEOUT = "30"
INTERVAL = "30"
RETRIES = "3"
START_PERIOD = "60"

# CRITICAL: Railway networking configuration
[deploy.envs.networking]
# Ensure Railway routes traffic to the correct port
FORCE_PORT = "3000"
# Enable Railway's internal health checks
ENABLE_INTERNAL_HEALTH_CHECKS = "true"
# Configure Railway proxy settings
PROXY_TIMEOUT = "30"
PROXY_RETRIES = "3"

# EMERGENCY RECOVERY INSTRUCTIONS:
# If database connection fails and application won't start:
# 1. Set SKIP_DATABASE = "true" in Railway environment variables
# 2. Set EMERGENCY_MODE = "true" in Railway environment variables
# 3. Redeploy the application
# 4. This will allow basic health checks and API structure to work
# 5. Fix database connection issues
# 6. Set SKIP_DATABASE back to "false" and redeploy

# CRITICAL RAILWAY ROUTING FIXES:
# 1. Health check path corrected to "/api/health"
# 2. Port explicitly set to 3000
# 3. Railway static URL configured
# 4. Health check timeouts optimized for Railway
# 5. Networking configuration added for proper routing
