# ROOT CAUSE: Pre-deploy runs from REPO ROOT, not from zephix-backend.
# So "npm run db:migrate" fails (root package.json has no db:migrate).
# Fix: preDeployCommand must cd into zephix-backend first.
#
# Healthcheck Path must be /api/health/ready (global prefix is api).
[build]
builder = "nixpacks"
buildCommand = "npm ci --legacy-peer-deps && npm run build"
postBuildCommand = "test -f dist/src/main.js || (echo 'dist/src/main.js missing' && exit 1)"

[deploy]
preDeployCommand = "cd zephix-backend && npm run db:migrate"
startCommand = "npm run start:railway"
healthcheckPath = "/api/health/ready"
healthcheckTimeout = 10
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3

# Port and env (Railway may override)
[deploy.envs]
NODE_ENV = "production"
PORT = "3000"
