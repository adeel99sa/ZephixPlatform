# Zephix Backend - Railway Service Configuration
# NestJS TypeScript Application
# 
# @author Zephix Development Team
# @version 2.1.0
# @description Service-specific Railway configuration for NestJS backend

[build]
builder = "NIXPACKS"

[deploy]
startCommand = "npm run start:prod"
healthcheckPath = "/api/health"
healthcheckTimeout = 300
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
[variables]
NODE_ENV = "production"
NODE_VERSION = "18"
PORT = "3000"
JWT_SECRET = "ZephixJWT2024SecureKey!"
JWT_EXPIRES_IN = "15m"
DATABASE_URL = "{{.Postgres.DATABASE_URL}}"
LOG_LEVEL = "info"
CORS_ORIGIN = "https://getzephix.com"
API_PREFIX = "/api"
NIXPACKS_BUILDER = "true"

# =============================================================================
# CRYPTO MODULE CONFIGURATION
# =============================================================================
# Ensure crypto module is available for Node.js v18+
NODE_OPTIONS = "--experimental-global-webcrypto"

# =============================================================================
# BUILD CONFIGURATION
# =============================================================================
[build.nixpacksConfig]
# Node.js version specification
providers = ["node"]

# Build phases
[build.nixpacksConfig.phases.setup]
cmds = ["npm ci --omit=dev"]

[build.nixpacksConfig.phases.install]
cmds = ["npm ci --omit=dev"]

[build.nixpacksConfig.phases.build]
cmds = ["npm run build"]

[build.nixpacksConfig.phases.start]
cmd = "npm run start:prod"

# =============================================================================
# RUNTIME CONFIGURATION
# =============================================================================
[deploy.nixpacksConfig]
# Production runtime settings
cmd = "node dist/main.js"

# =============================================================================
# RESOURCE ALLOCATION
# =============================================================================
[resources]
cpu = "0.5"
memory = "512MB"

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================
[security]
# CORS settings
cors = {
  enabled = true,
  origins = ["https://getzephix.com", "https://www.getzephix.com"]
}

# Rate limiting
rateLimit = {
  enabled = true,
  requests = 100,
  window = "1m"
}

# =============================================================================
# MONITORING CONFIGURATION
# =============================================================================
[monitoring]
# Logging settings
logging = {
  level = "info",
  retention = "30d"
}

# Health check configuration
healthCheck = {
  enabled = true,
  path = "/api/health",
  timeout = 300,
  interval = 30,
  retries = 3
}
