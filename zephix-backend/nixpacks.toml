# Zephix Backend - Nixpacks Configuration
# NestJS TypeScript Application Build Configuration
# 
# @author Zephix Development Team
# @version 2.2.0

[providers]
node = "20"

[variables]
NODE_VERSION = "20"
NODE_ENV = "production"
NIXPACKS_BUILDER = "true"
# CRITICAL FIX: Ensure crypto module is available for Node.js v20+
NODE_OPTIONS = "--experimental-global-webcrypto"

[phases.setup]
cmds = ["npm ci --omit=dev"]

[phases.install]
cmds = ["npm ci --omit=dev"]

[phases.build]
cmds = ["npm run build"]

# CRITICAL FIX: Verify build output structure
[phases.build.nixpacksConfig]
cmds = [
  "npm run build",
  "ls -la dist/",
  "find dist/ -name 'main.js'",
  "npm prune --production"
]

# CRITICAL FIX: Use explicit start command with correct path
[phases.start]
cmd = "node dist/main.js"

# =============================================================================
# BUILD OPTIMIZATION
# =============================================================================
[phases.build.nixpacksConfig]
# Ensure TypeScript compilation with crypto support
cmds = [
  "npm run build",
  "npm prune --production"
]

# =============================================================================
# RUNTIME CONFIGURATION
# =============================================================================
[phases.start.nixpacksConfig]
# Use explicit start command with correct path
cmd = "node dist/main.js"

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
[variables.nixpacksConfig]
NODE_ENV = "production"
PORT = "3000"
# Ensure crypto module is globally available
NODE_OPTIONS = "--experimental-global-webcrypto"
